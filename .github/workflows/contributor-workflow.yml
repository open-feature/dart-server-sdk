# This workflow analyzes the Dart Server SDK and an example project

name: Contributor Workflow

on:
  workflow_call: # Makes the workflow reusable
    inputs:
      branch_name:
        required: true
        type: string
      event_name:
        required: true
        type: string

jobs:
  analyze-core:
    name: Analyze Core Dart Server SDK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        # with:
        #   sdk: stable   # (optional; stable is the default)

      # Find the Dart package root (directory that has pubspec.yaml).
      - name: Locate package root
        id: pkg
        shell: bash
        run: |
          set -euo pipefail
          # Prefer repo root if it has a pubspec.yaml, otherwise take the first match.
          if [[ -f "pubspec.yaml" ]]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          else
            PKG_DIR=$(git ls-files | grep -E '(^|/)(pubspec\.yaml)$' | head -n 1 | xargs -r dirname)
            if [[ -z "${PKG_DIR:-}" ]]; then
              echo "No pubspec.yaml found in repository." >&2
              exit 1
            fi
            echo "dir=$PKG_DIR" >> "$GITHUB_OUTPUT"
          fi
          echo "Using package dir: $(cat $GITHUB_OUTPUT)"

      - name: Install Dependencies
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: |
          echo "Installing dependencies for core SDK..."
          dart pub get

      - name: Check for Outdated Dependencies
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: |
          echo "Checking for outdated dependencies..."
          dart pub outdated || true

      - name: Run Static Analysis (capture & show)
        id: analyze
        working-directory: ${{ steps.pkg.outputs.dir }}
        shell: bash
        run: |
          set -o pipefail
          echo "Running static analysis for core SDK..."
          # Write both stdout and stderr to files while also echoing to the log.
          # Keep stdout and stderr separate so we can categorize later.
          # stdout -> analysis_report.txt, stderr -> error_log.txt
          { dart analyze lib/ | tee analysis_report.txt; } 2> >(tee error_log.txt >&2)
          STATUS=${PIPESTATUS[0]}
          if [[ $STATUS -ne 0 ]]; then
            echo "❌ Static analysis failed. See error_log.txt below:"
            sed -n '1,200p' error_log.txt || true
          else
            echo "✅ Static analysis completed successfully. No critical errors found."
          fi
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          exit $STATUS || true  # Don’t fail the step here; allow categorization + artifacts.

      - name: Categorize and Count Analysis Results
        if: always()
        working-directory: ${{ steps.pkg.outputs.dir }}
        shell: bash
        run: |
          echo "Categorizing analysis results..."
          touch analysis_report.txt error_log.txt
          # Create categorized files (empty if none)
          grep -i "info"    analysis_report.txt > info_report.txt    || true
          grep -i "warning" analysis_report.txt > warning_report.txt || true
          grep -i "error"   analysis_report.txt > error_report.txt   || true

          INFO_COUNT=$(wc -l < info_report.txt || echo 0)
          WARNING_COUNT=$(wc -l < warning_report.txt || echo 0)
          ERROR_COUNT=$(wc -l < error_report.txt || echo 0)

          echo ""
          echo "Summary of analysis results:"
          echo "Informational messages: $INFO_COUNT"
          echo "Warnings: $WARNING_COUNT"
          echo "Errors: $ERROR_COUNT"
          echo ""

          if [[ $WARNING_COUNT -gt 0 ]]; then
            echo "Warnings (first 200 lines):"
            sed -n '1,200p' warning_report.txt
          fi

          if [[ $ERROR_COUNT -gt 0 ]]; then
            echo ""
            echo "Errors (first 200 lines):"
            sed -n '1,200p' error_report.txt
          fi

      - name: Identify Specific Commits for Issues
        if: always()
        working-directory: ${{ steps.pkg.outputs.dir }}
        shell: bash
        run: |
          echo "Identifying specific commits for files mentioned by analyzer..."
          # Collect .dart file paths mentioned by analyzer; tolerate empty sets
          FILES=$(awk -F: '{print $1}' analysis_report.txt | grep -E '\.dart$' | sort -u || true)

          if [[ -z "$FILES" ]]; then
            echo "No files with issues were reported by the analyzer."
            exit 0
          fi

          for file in $FILES; do
            if [[ -f "$file" ]]; then
              git_log=$(git -C "$GITHUB_WORKSPACE" log -n 1 --pretty=format:"%h by %an <%ae>" -- "$file" || true)
              echo "File: $file"
              echo "Last change: ${git_log:-unknown}"
              echo ""
            fi
          done

      - name: Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-sdk-analysis
          path: |
            ${{ steps.pkg.outputs.dir }}/analysis_report.txt
            ${{ steps.pkg.outputs.dir }}/error_log.txt
            ${{ steps.pkg.outputs.dir }}/info_report.txt
            ${{ steps.pkg.outputs.dir }}/warning_report.txt
            ${{ steps.pkg.outputs.dir }}/error_report.txt
          retention-days: 7

      # Fail the job if the analyzer actually failed.
      - name: Fail if analyzer failed
        if: ${{ steps.analyze.outputs.status != '0' }}
        run: |
          echo "❌ Failing job because the analyzer returned a non-zero exit code."
          exit 1
