name: Contributor Workflow

on:
  workflow_call:
    inputs:
      fail_on:            # 'never' | 'errors' | 'warnings'
        description: "When to fail the job"
        required: false
        default: errors
        type: string

jobs:
  analyze-core:
    name: Analyze Core Dart Server SDK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          dart-version: stable

      - name: Cache pub packages
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Print Dart version
        run: dart --version

      - name: Install Dependencies
        run: |
          echo "Installing dependencies for core SDK..."
          dart pub get

      # Run analyze, keep logs AND write to file, never fail step
      - name: Run Static Analysis (capture only)
        id: analyze
        shell: bash
        continue-on-error: true
        run: |
          set -o pipefail
          ART_DIR="artifacts/core-sdk"
          mkdir -p "$ART_DIR"

          echo "Running static analysis for core SDK..."
          # Write to both console and file
          dart analyze lib/ --format=human | tee "$ART_DIR/analysis_report.txt"
          ANALYZE_EXIT=${PIPESTATUS[0]}
          echo "analyzer_exit=$ANALYZE_EXIT" >> "$GITHUB_OUTPUT"

          # Bucket results (best-effort pattern matching on 'human' format)
          grep -iE " error "   "$ART_DIR/analysis_report.txt" > "$ART_DIR/error_report.txt"   || true
          grep -iE " warning " "$ART_DIR/analysis_report.txt" > "$ART_DIR/warning_report.txt" || true
          grep -iE " info "    "$ART_DIR/analysis_report.txt" > "$ART_DIR/info_report.txt"    || true

          echo "Analyze exit code: $ANALYZE_EXIT"

      - name: Summarize Results (Job Summary)
        id: bucket
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          ART_DIR="artifacts/core-sdk"
          RPT="$ART_DIR/analysis_report.txt"

          if [[ ! -f "$RPT" ]]; then
            echo "report_missing=true" >> "$GITHUB_OUTPUT"
            echo "## Dart analysis summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_No analysis report found._" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          ERR=$(wc -l < "$ART_DIR/error_report.txt"    2>/dev/null || echo 0)
          WARN=$(wc -l < "$ART_DIR/warning_report.txt" 2>/dev/null || echo 0)
          INF=$(wc -l < "$ART_DIR/info_report.txt"     2>/dev/null || echo 0)

          echo "errors=$ERR"     >> "$GITHUB_OUTPUT"
          echo "warnings=$WARN"  >> "$GITHUB_OUTPUT"
          echo "infos=$INF"      >> "$GITHUB_OUTPUT"

          {
            echo "## Dart analysis summary"
            echo
            echo "- **Errors:** $ERR"
            echo "- **Warnings:** $WARN"
            echo "- **Infos:** $INF"
            echo

            if [[ -s "$ART_DIR/error_report.txt" ]]; then
              echo "### Errors (first 30)"
              head -n 30 "$ART_DIR/error_report.txt" | sed 's/^/- /'
              echo
            fi

            if [[ -s "$ART_DIR/warning_report.txt" ]]; then
              echo "### Warnings (first 30)"
              head -n 30 "$ART_DIR/warning_report.txt" | sed 's/^/- /'
              echo
            fi

            if [[ -s "$ART_DIR/info_report.txt" ]]; then
              echo "### Infos (first 30)"
              head -n 30 "$ART_DIR/info_report.txt" | sed 's/^/- /'
              echo
            fi

            echo "<details><summary>Full analyzer output</summary>"
            echo
            sed 's/^/    /' "$RPT"
            echo
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Analysis Artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: core-sdk-analysis
          path: artifacts/core-sdk/**
          retention-days: 7

      # Single, explicit policy gate (defaults to: only fail on errors)
      - name: Gate on policy
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          FAIL_ON="${{ inputs.fail_on }}"
          ERR=${{ steps.bucket.outputs.errors || 0 }}
          WARN=${{ steps.bucket.outputs.warnings || 0 }}
          ANA_EXIT=${{ steps.analyze.outputs.analyzer_exit
